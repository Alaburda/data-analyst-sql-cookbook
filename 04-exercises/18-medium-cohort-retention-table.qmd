---
title: "[Medium] Cohort Retention Table"
filters:
  - interactive-duckdb
databases:
  - name: cookbook
    path: "https://raw.githubusercontent.com/Alaburda/data-analyst-sql-cookbook/master/db/cookbook.duckdb"
    format: duckdb
---

# Problem Statement

Build a monthly cohort retention analysis showing what percentage of users from each signup cohort continue to be active in subsequent months. This is a critical metric for subscription businesses and SaaS applications.

**Skills tested:** Date functions, Self-joins, CTEs, Pivoting, Cohort analysis, Retention calculations

## Schema

### customers
```
customer_id    INTEGER
email          VARCHAR
first_name     VARCHAR
last_name      VARCHAR
created_date   DATE
```

### orders
```
order_id       INTEGER
customer_id    INTEGER
order_date     DATE
status         VARCHAR
```

## Sample Data

```{.sql .interactive .cookbook}
-- View customer signup and order activity
SELECT 
    DATE_TRUNC('month', c.created_date) AS signup_month,
    COUNT(DISTINCT c.customer_id) AS new_customers,
    COUNT(DISTINCT o.customer_id) AS active_customers
FROM customers c
LEFT JOIN orders o ON c.customer_id = o.customer_id 
    AND o.status = 'completed'
    AND o.order_date >= c.created_date
WHERE c.created_date >= CURRENT_DATE - INTERVAL '12 months'
GROUP BY signup_month
ORDER BY signup_month DESC;
```

## Expected Output

| cohort_month | month_0 | month_1 | month_2 | month_3 | month_4 | month_5 | month_6 |
|--------------|---------|---------|---------|---------|---------|---------|---------|
| 2024-01      | 100.0%  | 45.2%   | 38.1%   | 34.5%   | 31.2%   | 29.8%   | 28.3%   |
| 2023-12      | 100.0%  | 43.8%   | 36.9%   | 33.2%   | 30.1%   | 28.5%   | 27.1%   |
| 2023-11      | 100.0%  | 44.5%   | 37.5%   | 33.8%   | 30.5%   | 29.0%   | â€”       |
| ...          | ...     | ...     | ...     | ...     | ...     | ...     | ...     |

## Requirements

1. Group customers into monthly cohorts by signup date
2. Calculate retention rate for each cohort in months 0-6 after signup
3. Month 0 = signup month (should be 100%)
4. Show retention as percentage of original cohort size
5. Only include completed orders
6. Only analyze cohorts from last 12 months

## Hints

<details>
<summary>Click to reveal hint 1</summary>

Calculate the number of months between signup and each order:
```sql
DATEDIFF('month', 
    DATE_TRUNC('month', c.created_date),
    DATE_TRUNC('month', o.order_date)
) AS months_since_signup
```

</details>

<details>
<summary>Click to reveal hint 2</summary>

Use conditional aggregation to pivot months into columns:
```sql
COUNT(DISTINCT CASE WHEN months_since_signup = 0 THEN customer_id END) AS month_0,
COUNT(DISTINCT CASE WHEN months_since_signup = 1 THEN customer_id END) AS month_1
```

</details>

<details>
<summary>Click to reveal hint 3</summary>

Calculate retention percentage based on cohort size:
```sql
ROUND(100.0 * month_1 / month_0, 1) AS month_1_pct
```

</details>

## Solution Template

```{.sql .interactive .cookbook}
WITH cohorts AS (
    SELECT 
        customer_id,
        DATE_TRUNC('month', created_date) AS cohort_month
    FROM customers
    WHERE created_date >= CURRENT_DATE - INTERVAL '12 months'
),
cohort_activity AS (
    SELECT 
        c.cohort_month,
        c.customer_id,
        -- Calculate months since signup
    FROM cohorts c
    LEFT JOIN orders o 
        ON c.customer_id = o.customer_id
        AND o.status = 'completed'
)
SELECT 
    cohort_month,
    COUNT(DISTINCT customer_id) AS cohort_size,
    -- Add retention counts for each month
FROM cohort_activity
GROUP BY cohort_month
ORDER BY cohort_month DESC;
```

## Solution

<details>
<summary>Click to reveal solution with absolute counts</summary>

```{.sql .interactive .cookbook}
WITH cohorts AS (
    SELECT 
        customer_id,
        DATE_TRUNC('month', created_date) AS cohort_month
    FROM customers
    WHERE created_date >= CURRENT_DATE - INTERVAL '12 months'
),
cohort_activity AS (
    SELECT 
        c.cohort_month,
        c.customer_id,
        DATEDIFF('month', c.cohort_month, DATE_TRUNC('month', o.order_date)) AS months_since_signup
    FROM cohorts c
    LEFT JOIN orders o 
        ON c.customer_id = o.customer_id
        AND o.status = 'completed'
        AND o.order_date >= c.cohort_month
)
SELECT 
    cohort_month,
    COUNT(DISTINCT customer_id) AS cohort_size,
    COUNT(DISTINCT CASE WHEN months_since_signup = 0 THEN customer_id END) AS month_0,
    COUNT(DISTINCT CASE WHEN months_since_signup = 1 THEN customer_id END) AS month_1,
    COUNT(DISTINCT CASE WHEN months_since_signup = 2 THEN customer_id END) AS month_2,
    COUNT(DISTINCT CASE WHEN months_since_signup = 3 THEN customer_id END) AS month_3,
    COUNT(DISTINCT CASE WHEN months_since_signup = 4 THEN customer_id END) AS month_4,
    COUNT(DISTINCT CASE WHEN months_since_signup = 5 THEN customer_id END) AS month_5,
    COUNT(DISTINCT CASE WHEN months_since_signup = 6 THEN customer_id END) AS month_6
FROM cohort_activity
GROUP BY cohort_month
ORDER BY cohort_month DESC;
```

</details>

<details>
<summary>Click to reveal solution with percentages</summary>

```{.sql .interactive .cookbook}
WITH cohorts AS (
    SELECT 
        customer_id,
        DATE_TRUNC('month', created_date) AS cohort_month
    FROM customers
    WHERE created_date >= CURRENT_DATE - INTERVAL '12 months'
),
cohort_sizes AS (
    SELECT 
        cohort_month,
        COUNT(DISTINCT customer_id) AS cohort_size
    FROM cohorts
    GROUP BY cohort_month
),
cohort_activity AS (
    SELECT 
        c.cohort_month,
        c.customer_id,
        DATEDIFF('month', c.cohort_month, DATE_TRUNC('month', o.order_date)) AS months_since_signup
    FROM cohorts c
    LEFT JOIN orders o 
        ON c.customer_id = o.customer_id
        AND o.status = 'completed'
        AND o.order_date >= c.cohort_month
),
retention_counts AS (
    SELECT 
        cohort_month,
        COUNT(DISTINCT CASE WHEN months_since_signup = 0 THEN customer_id END) AS month_0,
        COUNT(DISTINCT CASE WHEN months_since_signup = 1 THEN customer_id END) AS month_1,
        COUNT(DISTINCT CASE WHEN months_since_signup = 2 THEN customer_id END) AS month_2,
        COUNT(DISTINCT CASE WHEN months_since_signup = 3 THEN customer_id END) AS month_3,
        COUNT(DISTINCT CASE WHEN months_since_signup = 4 THEN customer_id END) AS month_4,
        COUNT(DISTINCT CASE WHEN months_since_signup = 5 THEN customer_id END) AS month_5,
        COUNT(DISTINCT CASE WHEN months_since_signup = 6 THEN customer_id END) AS month_6
    FROM cohort_activity
    GROUP BY cohort_month
)
SELECT 
    rc.cohort_month,
    cs.cohort_size,
    ROUND(100.0 * rc.month_0 / cs.cohort_size, 1) AS month_0_pct,
    ROUND(100.0 * rc.month_1 / cs.cohort_size, 1) AS month_1_pct,
    ROUND(100.0 * rc.month_2 / cs.cohort_size, 1) AS month_2_pct,
    ROUND(100.0 * rc.month_3 / cs.cohort_size, 1) AS month_3_pct,
    ROUND(100.0 * rc.month_4 / cs.cohort_size, 1) AS month_4_pct,
    ROUND(100.0 * rc.month_5 / cs.cohort_size, 1) AS month_5_pct,
    ROUND(100.0 * rc.month_6 / cs.cohort_size, 1) AS month_6_pct
FROM retention_counts rc
JOIN cohort_sizes cs ON rc.cohort_month = cs.cohort_month
ORDER BY rc.cohort_month DESC;
```

</details>

## Revenue Retention

<details>
<summary>Click to reveal revenue-based cohort analysis</summary>

Track total revenue from each cohort over time:

```{.sql .interactive .cookbook}
WITH cohorts AS (
    SELECT 
        customer_id,
        DATE_TRUNC('month', created_date) AS cohort_month
    FROM customers
    WHERE created_date >= CURRENT_DATE - INTERVAL '12 months'
),
cohort_revenue AS (
    SELECT 
        c.cohort_month,
        DATEDIFF('month', c.cohort_month, DATE_TRUNC('month', o.order_date)) AS months_since_signup,
        SUM(oi.line_total) AS revenue
    FROM cohorts c
    LEFT JOIN orders o 
        ON c.customer_id = o.customer_id
        AND o.status = 'completed'
        AND o.order_date >= c.cohort_month
    LEFT JOIN order_items oi ON o.order_id = oi.order_id
    GROUP BY c.cohort_month, months_since_signup
)
SELECT 
    cohort_month,
    ROUND(SUM(CASE WHEN months_since_signup = 0 THEN revenue ELSE 0 END), 2) AS month_0_revenue,
    ROUND(SUM(CASE WHEN months_since_signup = 1 THEN revenue ELSE 0 END), 2) AS month_1_revenue,
    ROUND(SUM(CASE WHEN months_since_signup = 2 THEN revenue ELSE 0 END), 2) AS month_2_revenue,
    ROUND(SUM(CASE WHEN months_since_signup = 3 THEN revenue ELSE 0 END), 2) AS month_3_revenue,
    ROUND(SUM(CASE WHEN months_since_signup = 4 THEN revenue ELSE 0 END), 2) AS month_4_revenue,
    ROUND(SUM(CASE WHEN months_since_signup = 5 THEN revenue ELSE 0 END), 2) AS month_5_revenue,
    ROUND(SUM(CASE WHEN months_since_signup = 6 THEN revenue ELSE 0 END), 2) AS month_6_revenue
FROM cohort_revenue
GROUP BY cohort_month
ORDER BY cohort_month DESC;
```

</details>

## Cumulative Retention

<details>
<summary>Click to reveal cumulative LTV by cohort</summary>

Show cumulative revenue per customer over time:

```{.sql .interactive .cookbook}
WITH cohorts AS (
    SELECT 
        customer_id,
        DATE_TRUNC('month', created_date) AS cohort_month
    FROM customers
    WHERE created_date >= CURRENT_DATE - INTERVAL '12 months'
),
cohort_sizes AS (
    SELECT 
        cohort_month,
        COUNT(DISTINCT customer_id) AS cohort_size
    FROM cohorts
    GROUP BY cohort_month
),
cohort_revenue AS (
    SELECT 
        c.cohort_month,
        DATEDIFF('month', c.cohort_month, DATE_TRUNC('month', o.order_date)) AS months_since_signup,
        SUM(oi.line_total) AS revenue
    FROM cohorts c
    LEFT JOIN orders o 
        ON c.customer_id = o.customer_id
        AND o.status = 'completed'
        AND o.order_date >= c.cohort_month
    LEFT JOIN order_items oi ON o.order_id = oi.order_id
    WHERE months_since_signup <= 6
    GROUP BY c.cohort_month, months_since_signup
),
monthly_revenue AS (
    SELECT 
        cohort_month,
        months_since_signup,
        revenue
    FROM cohort_revenue
)
SELECT 
    mr.cohort_month,
    cs.cohort_size,
    ROUND(SUM(CASE WHEN mr.months_since_signup <= 0 THEN mr.revenue ELSE 0 END) / cs.cohort_size, 2) AS ltv_month_0,
    ROUND(SUM(CASE WHEN mr.months_since_signup <= 1 THEN mr.revenue ELSE 0 END) / cs.cohort_size, 2) AS ltv_month_1,
    ROUND(SUM(CASE WHEN mr.months_since_signup <= 2 THEN mr.revenue ELSE 0 END) / cs.cohort_size, 2) AS ltv_month_2,
    ROUND(SUM(CASE WHEN mr.months_since_signup <= 3 THEN mr.revenue ELSE 0 END) / cs.cohort_size, 2) AS ltv_month_3,
    ROUND(SUM(CASE WHEN mr.months_since_signup <= 4 THEN mr.revenue ELSE 0 END) / cs.cohort_size, 2) AS ltv_month_4,
    ROUND(SUM(CASE WHEN mr.months_since_signup <= 5 THEN mr.revenue ELSE 0 END) / cs.cohort_size, 2) AS ltv_month_5,
    ROUND(SUM(CASE WHEN mr.months_since_signup <= 6 THEN mr.revenue ELSE 0 END) / cs.cohort_size, 2) AS ltv_month_6
FROM monthly_revenue mr
JOIN cohort_sizes cs ON mr.cohort_month = cs.cohort_month
GROUP BY mr.cohort_month, cs.cohort_size
ORDER BY mr.cohort_month DESC;
```

</details>

## Weekly Cohorts

<details>
<summary>Click to reveal weekly cohort analysis</summary>

More granular analysis with weekly cohorts:

```{.sql .interactive .cookbook}
WITH cohorts AS (
    SELECT 
        customer_id,
        DATE_TRUNC('week', created_date) AS cohort_week
    FROM customers
    WHERE created_date >= CURRENT_DATE - INTERVAL '12 weeks'
),
cohort_sizes AS (
    SELECT 
        cohort_week,
        COUNT(DISTINCT customer_id) AS cohort_size
    FROM cohorts
    GROUP BY cohort_week
),
cohort_activity AS (
    SELECT 
        c.cohort_week,
        c.customer_id,
        FLOOR(DATEDIFF('day', c.cohort_week, o.order_date) / 7) AS weeks_since_signup
    FROM cohorts c
    LEFT JOIN orders o 
        ON c.customer_id = o.customer_id
        AND o.status = 'completed'
        AND o.order_date >= c.cohort_week
),
retention_counts AS (
    SELECT 
        cohort_week,
        COUNT(DISTINCT CASE WHEN weeks_since_signup = 0 THEN customer_id END) AS week_0,
        COUNT(DISTINCT CASE WHEN weeks_since_signup = 1 THEN customer_id END) AS week_1,
        COUNT(DISTINCT CASE WHEN weeks_since_signup = 2 THEN customer_id END) AS week_2,
        COUNT(DISTINCT CASE WHEN weeks_since_signup = 3 THEN customer_id END) AS week_3,
        COUNT(DISTINCT CASE WHEN weeks_since_signup = 4 THEN customer_id END) AS week_4
    FROM cohort_activity
    GROUP BY cohort_week
)
SELECT 
    rc.cohort_week,
    cs.cohort_size,
    ROUND(100.0 * rc.week_0 / cs.cohort_size, 1) AS week_0_pct,
    ROUND(100.0 * rc.week_1 / cs.cohort_size, 1) AS week_1_pct,
    ROUND(100.0 * rc.week_2 / cs.cohort_size, 1) AS week_2_pct,
    ROUND(100.0 * rc.week_3 / cs.cohort_size, 1) AS week_3_pct,
    ROUND(100.0 * rc.week_4 / cs.cohort_size, 1) AS week_4_pct
FROM retention_counts rc
JOIN cohort_sizes cs ON rc.cohort_week = cs.cohort_week
WHERE cs.cohort_size >= 10  -- Only show cohorts with sufficient size
ORDER BY rc.cohort_week DESC;
```

</details>

## Retention Curves

<details>
<summary>Click to reveal average retention curve</summary>

Calculate average retention across all cohorts:

```{.sql .interactive .cookbook}
WITH cohorts AS (
    SELECT 
        customer_id,
        DATE_TRUNC('month', created_date) AS cohort_month
    FROM customers
    WHERE created_date >= CURRENT_DATE - INTERVAL '12 months'
        AND created_date <= CURRENT_DATE - INTERVAL '6 months'  -- Only complete cohorts
),
cohort_sizes AS (
    SELECT 
        cohort_month,
        COUNT(DISTINCT customer_id) AS cohort_size
    FROM cohorts
    GROUP BY cohort_month
),
cohort_activity AS (
    SELECT 
        c.cohort_month,
        c.customer_id,
        DATEDIFF('month', c.cohort_month, DATE_TRUNC('month', o.order_date)) AS months_since_signup
    FROM cohorts c
    LEFT JOIN orders o 
        ON c.customer_id = o.customer_id
        AND o.status = 'completed'
        AND o.order_date >= c.cohort_month
),
monthly_retention AS (
    SELECT 
        ca.cohort_month,
        ca.months_since_signup,
        COUNT(DISTINCT ca.customer_id) AS active_users,
        cs.cohort_size
    FROM cohort_activity ca
    JOIN cohort_sizes cs ON ca.cohort_month = cs.cohort_month
    WHERE ca.months_since_signup IS NOT NULL
    GROUP BY ca.cohort_month, ca.months_since_signup, cs.cohort_size
)
SELECT 
    months_since_signup,
    ROUND(AVG(100.0 * active_users / cohort_size), 1) AS avg_retention_pct,
    ROUND(MIN(100.0 * active_users / cohort_size), 1) AS min_retention_pct,
    ROUND(MAX(100.0 * active_users / cohort_size), 1) AS max_retention_pct,
    COUNT(DISTINCT cohort_month) AS cohort_count
FROM monthly_retention
WHERE months_since_signup BETWEEN 0 AND 6
GROUP BY months_since_signup
ORDER BY months_since_signup;
```

</details>

## Acquisition Channel Cohorts

<details>
<summary>Click to reveal retention by acquisition source</summary>

Compare retention across different customer acquisition channels:

```{.sql .interactive .cookbook}
WITH cohorts AS (
    SELECT 
        c.customer_id,
        DATE_TRUNC('month', c.created_date) AS cohort_month,
        COALESCE(c.acquisition_channel, 'Unknown') AS channel
    FROM customers c
    WHERE c.created_date >= CURRENT_DATE - INTERVAL '12 months'
),
cohort_sizes AS (
    SELECT 
        cohort_month,
        channel,
        COUNT(DISTINCT customer_id) AS cohort_size
    FROM cohorts
    GROUP BY cohort_month, channel
),
cohort_activity AS (
    SELECT 
        c.cohort_month,
        c.channel,
        c.customer_id,
        DATEDIFF('month', c.cohort_month, DATE_TRUNC('month', o.order_date)) AS months_since_signup
    FROM cohorts c
    LEFT JOIN orders o 
        ON c.customer_id = o.customer_id
        AND o.status = 'completed'
        AND o.order_date >= c.cohort_month
),
retention_by_channel AS (
    SELECT 
        ca.channel,
        ca.months_since_signup,
        COUNT(DISTINCT ca.customer_id) AS active_users,
        AVG(cs.cohort_size) AS avg_cohort_size
    FROM cohort_activity ca
    JOIN cohort_sizes cs ON ca.cohort_month = cs.cohort_month AND ca.channel = cs.channel
    WHERE ca.months_since_signup BETWEEN 0 AND 3
    GROUP BY ca.channel, ca.months_since_signup
)
SELECT 
    channel,
    months_since_signup,
    ROUND(100.0 * active_users / avg_cohort_size, 1) AS retention_pct
FROM retention_by_channel
ORDER BY channel, months_since_signup;
```

</details>

## Extensions

1. **Churn prediction:** Identify early signals of customers likely to churn
2. **Reactivation campaigns:** Find churned customers to target with win-back offers
3. **Product category retention:** Track retention by first product category purchased
4. **Geographic cohorts:** Compare retention across regions or countries
5. **Cohort size sensitivity:** Analyze if initial cohort size affects retention
6. **Dynamic time windows:** Allow flexible retention window definitions (30/60/90 days)
